- platform: command_line
  command: '/home/hass/.homeassistant/cmds/tomato_smb_check'
  name: 'smb online'
  device_class: connectivity
  payload_on: "success"
  payload_off: "fail"
  scan_interval: 300

- platform: command_line
  command: '/home/hass/.homeassistant/cmds/bravia_check'
  name: 'bravia'
  device_class: plug
  payload_on: "success"
  payload_off: "fail"
  scan_interval: 300

- platform: template
  sensors:
    isp_conn:
      device_class: connectivity
      delay_off:
        minutes: 16
      value_template: >-
        {%- if states.sensor.ping_isp.state == 'n/a' or
          states.sensor.ping_isp.state | float > 150 -%}
          False
        {%- else -%}
          True
        {%- endif %}
    batts_low:
      device_class: battery
      value_template: >-
        {%- if states.sensor.dht22_176e41_battery.state and
                states.sensor.bme280_171f93_battery.state -%}
          {%- if
            states.sensor.dht22_176e41_battery.state|float <= states.input_number.slider_batt_level_v.state|float or
            states.sensor.bme280_171f93_battery.state|float <= states.input_number.slider_batt_level_v.state|float or
            states.sensor.root_battery.state|float <= states.input_number.slider_batt_level_p.state|float or
            is_state_attr('climate.living', 'low_battery', true) -%}
            True
          {%- else -%}
            False
          {%- endif %}
        {%- else -%}
          True
        {%- endif %}
    bedlight:
      device_class: light
      value_template: >-
        {%-if is_state("sun.sun", "below_horizon") and
             is_state("device_tracker.m4b30x", "home") -%}
          {%-if is_state("device_tracker.n0ll", "home") -%}
            False
          {%- else -%}
            {%- set  t =  (as_timestamp(now()) - as_timestamp(now().strftime('%Y-%m-%d 00:00')))-%}
            {%- set  ts =  states.input_datetime.bedl_time_start.attributes.timestamp -%}
            {%- set  te =  states.input_datetime.bedl_time_end.attributes.timestamp -%}
            {%-if (is_state("binary_sensor.sound_bar_active", "off") and
                  (ts < t or t < te) or
                  is_state("timer.just_home", "active"))
            -%}
              True
            {%- else -%}
              False
            {%- endif -%}
          {%- endif -%}
        {%- else -%}
          False
        {%- endif -%}
    sound_bar_active:
      device_class: sound
      delay_off:
        seconds: 60
      value_template: '{{
                          is_state("media_player.htmt500501_b34d6a", "playing") or
                            ((is_state("switch.tv_cec", "on") or
                                not is_state("media_player.kodi", "idle")) and
                                not is_state("media_player.kodi", "off"))
                          }}'
    bedmusic:
      device_class: sound
      delay_on:
        seconds: 60
      delay_off:
        seconds: 60
      value_template: >-
        {%-if is_state("sun.sun", "below_horizon") and
             is_state("device_tracker.m4b30x", "home") -%}
          {%-if is_state("device_tracker.n0ll", "home") -%}
            False
          {%- else -%}
            {%- set  t =  (as_timestamp(now()) - as_timestamp(now().strftime('%Y-%m-%d 00:00')))-%}
            {%- set  ts =  states.input_datetime.bedm_time_start.attributes.timestamp -%}
            {%- set  te =  states.input_datetime.bedm_time_end.attributes.timestamp -%}
            {%-if (is_state("binary_sensor.sound_bar_active", "off") and
                  (ts < t or t < te))
            -%}
              True
            {%- else -%}
              False
            {%- endif -%}
          {%- endif -%}
        {%- else -%}
          False
        {%- endif -%}
    home_heating:
      device_class: heat
      delay_on:
        seconds: 300
      delay_off:
        seconds: 300
      value_template: >-
        {{
          is_state("device_tracker.n0ll", "home") or
          is_state("binary_sensor.sound_bar_active", "on")
        }}
    open_living:
      device_class: opening
      value_template: >-
        {%- if states('climate.living') != 'unknown' -%}
          {{ states.climate.living.attributes.window_open }}
        {% else -%}
          {{ is_state('binary_sensor.open_living', 'on') }}
        {%- endif -%}
    bed_motion:
      device_class: motion
      value_template: '{{ is_state("timer.bed_motion_timer", "active") }}'
    living_motion:
      device_class: motion
      value_template: '{{ is_state("timer.living_motion_timer", "active") }}'
    hall_motion:
      device_class: motion
      value_template: '{{ is_state("timer.hall_motion_timer", "active") }}'
    home_motion:
      device_class: safety
      value_template: '{{ is_state("input_boolean.home_motion", "on") }}'

- platform: esp_wd
  name: x1
  host: !secret esp_host_x1
  scan_interval: 300

- platform: esp_wd
  name: bedroom
  host: !secret bedroom
  scan_interval: 300

#uptimerobot.com angelgabriel.branson@oou.us
- platform: rest
  name: ext_port
  resource: https://api.uptimerobot.com/v2/getMonitors
  method: POST
  device_class: connectivity
  payload: api_key=m779688698-f03f19ccae5797b5123ea799&format=json&logs=0
  headers:
    Content-Type: application/x-www-form-urlencoded
    Cache-Control: no-cache
  value_template: '{{ value_json.monitors[0].status|int == 2 }}'
  scan_interval: 300

#- platform: bayesian
#  name: bedlight
#  prior: 0.2
#  probability_threshold: 0.85
#  observations:
#    - entity_id: sensor.sun
#      prob_given_true: 0.8
#      platform: state
#      to_state: below_horizon
#    - entity_id: device_tracker.m4b30x
#      prob_given_true: 0.6
#      platform: state
#      to_state: home
#    - entity_id: device_tracker.n0ll
#      prob_given_true: 0.7
#      platform: state
#      to_state: not_home
#    - entity_id: media_player.kodi
#      prob_given_true: 0.9
#      platform: state
#      to_state: idle
