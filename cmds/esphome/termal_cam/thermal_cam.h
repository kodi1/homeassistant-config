#ifndef __WLED_BOARD_H__
#define __WLED_BOARD_H__

static const char *const TAG = "thermal_cam";

static const int out_w = 60; 
static const int out_h = 80;

static uint16_t* heatmap_buf = nullptr;

static lv_color_t legend_buffer[10 * 256];

static const uint16_t ironbow[256] = {
    0x0000, 0x0000, 0x0000, 0x0001, 0x0001, 0x0001, 0x0001, 0x0802,
    0x0802, 0x0802, 0x0802, 0x0802, 0x0803, 0x0803, 0x0803, 0x0803,
    0x0804, 0x0804, 0x0804, 0x0804, 0x0804, 0x1005, 0x1005, 0x1005,
    0x1005, 0x1005, 0x1006, 0x1006, 0x1006, 0x1006, 0x1007, 0x1007,
    0x1007, 0x1007, 0x1007, 0x1808, 0x1808, 0x1808, 0x1808, 0x1809,
    0x1809, 0x1809, 0x1809, 0x1809, 0x200a, 0x200a, 0x200a, 0x280a,
    0x280a, 0x280a, 0x300b, 0x300b, 0x300b, 0x380b, 0x380b, 0x380c,
    0x400c, 0x400c, 0x400c, 0x480c, 0x480c, 0x480d, 0x500d, 0x500d,
    0x500d, 0x500d, 0x580e, 0x580e, 0x580e, 0x600e, 0x600e, 0x600e,
    0x680f, 0x680f, 0x680f, 0x700f, 0x700f, 0x7010, 0x7810, 0x7810,
    0x7810, 0x8010, 0x8011, 0x8011, 0x8811, 0x8811, 0x8811, 0x9030,
    0x9030, 0x902f, 0x902f, 0x984f, 0x984e, 0x984e, 0x986d, 0xa06d,
    0xa06d, 0xa08c, 0xa08c, 0xa88b, 0xa88b, 0xa8ab, 0xa8aa, 0xb0aa,
    0xb0c9, 0xb0c9, 0xb0c9, 0xb8e8, 0xb8e8, 0xb8e7, 0xb8e7, 0xc107,
    0xc106, 0xc106, 0xc125, 0xc925, 0xc925, 0xc924, 0xc944, 0xd143,
    0xd143, 0xd163, 0xd162, 0xd962, 0xd981, 0xd981, 0xe181, 0xe180,
    0xe1a0, 0xe1c0, 0xe1c0, 0xe1e0, 0xe200, 0xe220, 0xe220, 0xe240,
    0xea60, 0xea80, 0xea80, 0xeaa0, 0xeac0, 0xeae0, 0xeae0, 0xeb00,
    0xeb20, 0xeb40, 0xeb40, 0xeb60, 0xeb80, 0xeba0, 0xf3a0, 0xf3c0,
    0xf3e0, 0xf400, 0xf400, 0xf420, 0xf440, 0xf440, 0xf460, 0xf480,
    0xf4a0, 0xf4a0, 0xf4c0, 0xf4e0, 0xfd00, 0xfd00, 0xfd20, 0xfd40,
    0xfd60, 0xfd60, 0xfd80, 0xfd81, 0xfda1, 0xfda2, 0xfdc2, 0xfdc3,
    0xfdc3, 0xfde4, 0xfde4, 0xfde5, 0xfe05, 0xfe06, 0xfe26, 0xfe27,
    0xfe27, 0xfe48, 0xfe48, 0xfe49, 0xfe69, 0xfe6a, 0xfe8a, 0xfe8b,
    0xfe8b, 0xfeac, 0xfeac, 0xfead, 0xfecd, 0xfece, 0xfece, 0xfeef,
    0xfeef, 0xff10, 0xff10, 0xff11, 0xff31, 0xff32, 0xff32, 0xff53,
    0xff53, 0xff74, 0xff74, 0xff75, 0xff95, 0xff96, 0xff96, 0xff96,
    0xff96, 0xff97, 0xff97, 0xff97, 0xff97, 0xff98, 0xffb8, 0xffb8,
    0xffb8, 0xffb8, 0xffb9, 0xffb9, 0xffb9, 0xffb9, 0xffba, 0xffba,
    0xffba, 0xffba, 0xffba, 0xffdb, 0xffdb, 0xffdb, 0xffdb, 0xffdb,
    0xffdc, 0xffdc, 0xffdc, 0xffdc, 0xffdd, 0xffdd, 0xffdd, 0xffdd,
    0xffdd, 0xfffe, 0xfffe, 0xfffe, 0xfffe, 0xffff, 0xffff, 0xffff
};

static const uint16_t viridis[256] = {
    0x400a, 0x402a, 0x402a, 0x402b, 0x404b, 0x404b, 0x404b, 0x406b,
    0x406b, 0x406b, 0x406b, 0x408b, 0x408c, 0x408c, 0x40ac, 0x40ac,
    0x40ac, 0x40cc, 0x40cc, 0x40cc, 0x40ec, 0x40ed, 0x40ed, 0x410d,
    0x410d, 0x410d, 0x410d, 0x412d, 0x412d, 0x412d, 0x414e, 0x414e,
    0x414e, 0x416e, 0x416e, 0x416e, 0x418e, 0x418e, 0x418e, 0x41af,
    0x41af, 0x41af, 0x41af, 0x41cf, 0x41cf, 0x41cf, 0x41ef, 0x41ef,
    0x41f0, 0x4210, 0x4210, 0x4210, 0x4230, 0x4230, 0x4230, 0x4230,
    0x4251, 0x4251, 0x4251, 0x4271, 0x3a71, 0x3a71, 0x3a71, 0x3a91,
    0x3a91, 0x3a91, 0x3ab1, 0x3ab1, 0x3ab1, 0x3ab1, 0x3ad1, 0x3ad1,
    0x3ad1, 0x3ad1, 0x3af1, 0x3af1, 0x32f1, 0x32f1, 0x3311, 0x3311,
    0x3311, 0x3331, 0x3331, 0x3331, 0x3331, 0x3351, 0x3351, 0x3351,
    0x3351, 0x3371, 0x3371, 0x3371, 0x3371, 0x2b91, 0x2b91, 0x2b91,
    0x2b91, 0x2bb1, 0x2bb1, 0x2bb1, 0x2bb1, 0x2bd1, 0x2bd1, 0x2bd1,
    0x2bd1, 0x2bf1, 0x2bf1, 0x2bf1, 0x2bf1, 0x2c11, 0x2411, 0x2411,
    0x2411, 0x2431, 0x2431, 0x2431, 0x2431, 0x2451, 0x2451, 0x2451,
    0x2451, 0x2471, 0x2471, 0x2471, 0x2471, 0x2491, 0x2491, 0x2491,
    0x2491, 0x24b1, 0x24b1, 0x24b1, 0x24b0, 0x24d0, 0x24d0, 0x24d0,
    0x24d0, 0x24f0, 0x24f0, 0x24f0, 0x24f0, 0x2510, 0x2510, 0x2510,
    0x2510, 0x2530, 0x2530, 0x2530, 0x252f, 0x2d4f, 0x2d4f, 0x2d4f,
    0x2d4f, 0x2d6f, 0x2d6f, 0x2d6f, 0x2d6f, 0x358f, 0x358e, 0x358e,
    0x358e, 0x35ae, 0x35ae, 0x35ae, 0x35ae, 0x3dce, 0x3dce, 0x3dce,
    0x3dcd, 0x3ded, 0x3ded, 0x3ded, 0x45ed, 0x45ed, 0x460c, 0x4e0c,
    0x4e0c, 0x4e0c, 0x4e0c, 0x562b, 0x562b, 0x562b, 0x562b, 0x5e2b,
    0x5e4a, 0x5e4a, 0x664a, 0x664a, 0x664a, 0x6669, 0x6e69, 0x6e69,
    0x6e69, 0x7669, 0x7668, 0x7688, 0x7688, 0x7e88, 0x7e88, 0x7e87,
    0x8687, 0x86a7, 0x86a7, 0x8ea7, 0x8ea7, 0x8ea7, 0x8ea7, 0x96a6,
    0x96a6, 0x96a6, 0x9ea6, 0x9ea6, 0x9ec6, 0xa6c6, 0xa6c6, 0xa6c5,
    0xaec5, 0xaec5, 0xaec5, 0xb6c5, 0xb6c5, 0xb6c5, 0xb6c4, 0xbee4,
    0xbee4, 0xbee4, 0xc6e4, 0xc6e4, 0xc6e4, 0xc6e4, 0xcee4, 0xcee4,
    0xcee4, 0xcee4, 0xd6e4, 0xd704, 0xd704, 0xd704, 0xdf04, 0xdf04,
    0xdf04, 0xdf04, 0xe704, 0xe704, 0xe704, 0xe704, 0xef04, 0xef04,
    0xef24, 0xef24, 0xf724, 0xf724, 0xf724, 0xf724, 0xff24, 0xff24
};

static const uint16_t lava[256] = {
    0x0000, 0x0000, 0x0000, 0x0800, 0x0800, 0x0800, 0x0800, 0x1000,
    0x1000, 0x1000, 0x1000, 0x1000, 0x1800, 0x1800, 0x1800, 0x1800,
    0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2800, 0x2800, 0x2800,
    0x2800, 0x2800, 0x3000, 0x3000, 0x3000, 0x3000, 0x3800, 0x3800,
    0x3800, 0x3800, 0x3800, 0x4000, 0x4000, 0x4000, 0x4000, 0x4800,
    0x4800, 0x4800, 0x4800, 0x4800, 0x5000, 0x5000, 0x5000, 0x5800,
    0x5800, 0x5800, 0x5800, 0x6000, 0x6000, 0x6000, 0x6800, 0x6800,
    0x6800, 0x7000, 0x7000, 0x7000, 0x7000, 0x7800, 0x7800, 0x7800,
    0x8000, 0x8000, 0x8000, 0x8000, 0x8800, 0x8800, 0x8800, 0x9000,
    0x9000, 0x9000, 0x9000, 0x9800, 0x9800, 0x9800, 0xa000, 0xa000,
    0xa000, 0xa800, 0xa800, 0xa800, 0xa800, 0xb000, 0xb000, 0xb020,
    0xb020, 0xb840, 0xb840, 0xb860, 0xb860, 0xb880, 0xc080, 0xc080,
    0xc0a0, 0xc0a0, 0xc8c0, 0xc8c0, 0xc8e0, 0xc8e0, 0xc900, 0xd100,
    0xd100, 0xd120, 0xd120, 0xd940, 0xd940, 0xd960, 0xd960, 0xd980,
    0xe180, 0xe180, 0xe1a0, 0xe1a0, 0xe1c0, 0xe9c0, 0xe9e0, 0xe9e0,
    0xea00, 0xf200, 0xf200, 0xf220, 0xf220, 0xf240, 0xfa40, 0xfa60,
    0xfa60, 0xfa80, 0xfa80, 0xfaa0, 0xfac0, 0xfac0, 0xfae0, 0xfae0,
    0xfb00, 0xfb20, 0xfb20, 0xfb40, 0xfb40, 0xfb60, 0xfb60, 0xfb80,
    0xfba0, 0xfba0, 0xfbc0, 0xfbc0, 0xfbe0, 0xfc00, 0xfc00, 0xfc20,
    0xfc20, 0xfc40, 0xfc60, 0xfc60, 0xfc80, 0xfc80, 0xfca0, 0xfcc0,
    0xfcc0, 0xfce0, 0xfce0, 0xfd00, 0xfd20, 0xfd20, 0xfd40, 0xfd40,
    0xfd60, 0xfd80, 0xfd80, 0xfda0, 0xfda1, 0xfda1, 0xfdc2, 0xfdc2,
    0xfde3, 0xfde3, 0xfe04, 0xfe04, 0xfe24, 0xfe25, 0xfe25, 0xfe46,
    0xfe46, 0xfe67, 0xfe67, 0xfe87, 0xfe88, 0xfea8, 0xfea9, 0xfea9,
    0xfeca, 0xfeca, 0xfeeb, 0xfeeb, 0xff0b, 0xff0c, 0xff2c, 0xff2d,
    0xff2d, 0xff4e, 0xff4e, 0xff6e, 0xff6f, 0xff8f, 0xff90, 0xffb0,
    0xffb1, 0xffb1, 0xffd2, 0xffd2, 0xfff2, 0xfff3, 0xfff3, 0xfff3,
    0xfff4, 0xfff4, 0xfff4, 0xfff4, 0xfff5, 0xfff5, 0xfff5, 0xfff6,
    0xfff6, 0xfff6, 0xfff7, 0xfff7, 0xfff7, 0xfff7, 0xfff8, 0xfff8,
    0xfff8, 0xfff9, 0xfff9, 0xfff9, 0xfff9, 0xfffa, 0xfffa, 0xfffa,
    0xfffb, 0xfffb, 0xfffb, 0xfffb, 0xfffc, 0xfffc, 0xfffc, 0xfffd,
    0xfffd, 0xfffd, 0xfffe, 0xfffe, 0xfffe, 0xfffe, 0xffff, 0xffff
};

static const uint16_t inferno[256] = {
    0x0000, 0x0001, 0x0001, 0x0001, 0x0001, 0x0001, 0x0802, 0x0802,
    0x0802, 0x0802, 0x0802, 0x0803, 0x0803, 0x0803, 0x0823, 0x0823,
    0x0824, 0x0824, 0x0824, 0x1024, 0x1024, 0x1025, 0x1025, 0x1025,
    0x1025, 0x1026, 0x1026, 0x1026, 0x1826, 0x1827, 0x1827, 0x1827,
    0x1827, 0x1828, 0x1828, 0x2028, 0x2028, 0x2029, 0x2029, 0x2029,
    0x2029, 0x282a, 0x282a, 0x282a, 0x282a, 0x284b, 0x284b, 0x284b,
    0x304b, 0x304b, 0x304b, 0x304c, 0x304c, 0x304c, 0x384c, 0x384c,
    0x384c, 0x384c, 0x384c, 0x384d, 0x404d, 0x404d, 0x404d, 0x404d,
    0x406d, 0x406d, 0x486d, 0x486e, 0x486e, 0x486e, 0x486e, 0x486e,
    0x506e, 0x506e, 0x506e, 0x506e, 0x508e, 0x588e, 0x588e, 0x588e,
    0x588e, 0x588e, 0x588e, 0x608e, 0x60ae, 0x60ae, 0x60ae, 0x60ae,
    0x60ae, 0x68ae, 0x68ae, 0x68ae, 0x68ae, 0x68ce, 0x70ce, 0x70ce,
    0x70ce, 0x70ce, 0x70ce, 0x70ee, 0x78ee, 0x78ee, 0x78ee, 0x78ee,
    0x78ed, 0x80ed, 0x810d, 0x810d, 0x810d, 0x810d, 0x810d, 0x890d,
    0x890d, 0x892d, 0x892d, 0x892d, 0x912d, 0x912d, 0x912c, 0x914c,
    0x914c, 0x994c, 0x994c, 0x994c, 0x996c, 0x996c, 0x996b, 0xa16b,
    0xa16b, 0xa18b, 0xa18b, 0xa18b, 0xa98b, 0xa98b, 0xa9ab, 0xa9aa,
    0xa9aa, 0xb1aa, 0xb1aa, 0xb1ca, 0xb1ca, 0xb1ca, 0xb1c9, 0xb9e9,
    0xb9e9, 0xb9e9, 0xb9e9, 0xba09, 0xba09, 0xc208, 0xc228, 0xc228,
    0xc228, 0xc228, 0xc248, 0xca48, 0xca47, 0xca47, 0xca67, 0xca67,
    0xca67, 0xd287, 0xd286, 0xd286, 0xd2a6, 0xd2a6, 0xd2a6, 0xd2c6,
    0xdac6, 0xdac6, 0xdae5, 0xdae5, 0xdb05, 0xdb05, 0xdb05, 0xdb25,
    0xe325, 0xe345, 0xe344, 0xe344, 0xe364, 0xe364, 0xe364, 0xeb84,
    0xeb84, 0xeba3, 0xeba3, 0xeba3, 0xebc3, 0xebc3, 0xebe3, 0xebe3,
    0xec03, 0xec03, 0xec23, 0xec23, 0xf443, 0xf443, 0xf463, 0xf463,
    0xf483, 0xf483, 0xf4a3, 0xf4a3, 0xf4c3, 0xf4c3, 0xf4e3, 0xf4e3,
    0xf503, 0xf503, 0xf524, 0xf524, 0xf544, 0xf544, 0xf565, 0xf565,
    0xf585, 0xf586, 0xf5a6, 0xf5a6, 0xf5c6, 0xf5c7, 0xf5e7, 0xf5e7,
    0xf608, 0xf608, 0xf628, 0xf629, 0xf649, 0xf649, 0xf669, 0xf66a,
    0xf68a, 0xfe8a, 0xfeab, 0xfeab, 0xfecc, 0xfecc, 0xfeed, 0xfeed,
    0xff0e, 0xff0e, 0xff2e, 0xff2f, 0xff4f, 0xff50, 0xff70, 0xff71,
    0xff91, 0xff91, 0xffb2, 0xffb2, 0xffb3, 0xffd3, 0xffd4, 0xfff4
};

static const uint16_t whitehot[256] = {
    0x0000, 0x0000, 0x0000, 0x0000, 0x0020, 0x0020, 0x0020, 0x0020,
    0x0841, 0x0841, 0x0841, 0x0841, 0x0861, 0x0861, 0x0861, 0x0861,
    0x1082, 0x1082, 0x1082, 0x1082, 0x10a2, 0x10a2, 0x10a2, 0x10a2,
    0x18c3, 0x18c3, 0x18c3, 0x18c3, 0x18e3, 0x18e3, 0x18e3, 0x18e3,
    0x2104, 0x2104, 0x2104, 0x2104, 0x2124, 0x2124, 0x2124, 0x2124,
    0x2945, 0x2945, 0x2945, 0x2945, 0x2965, 0x2965, 0x2965, 0x2965,
    0x3186, 0x3186, 0x3186, 0x3186, 0x31a6, 0x31a6, 0x31a6, 0x31a6,
    0x39c7, 0x39c7, 0x39c7, 0x39c7, 0x39e7, 0x39e7, 0x39e7, 0x39e7,
    0x4208, 0x4208, 0x4208, 0x4208, 0x4228, 0x4228, 0x4228, 0x4228,
    0x4a49, 0x4a49, 0x4a49, 0x4a49, 0x4a69, 0x4a69, 0x4a69, 0x4a69,
    0x528a, 0x528a, 0x528a, 0x528a, 0x52aa, 0x52aa, 0x52aa, 0x52aa,
    0x5acb, 0x5acb, 0x5acb, 0x5acb, 0x5aeb, 0x5aeb, 0x5aeb, 0x5aeb,
    0x630c, 0x630c, 0x630c, 0x630c, 0x632c, 0x632c, 0x632c, 0x632c,
    0x6b4d, 0x6b4d, 0x6b4d, 0x6b4d, 0x6b6d, 0x6b6d, 0x6b6d, 0x6b6d,
    0x738e, 0x738e, 0x738e, 0x738e, 0x73ae, 0x73ae, 0x73ae, 0x73ae,
    0x7bcf, 0x7bcf, 0x7bcf, 0x7bcf, 0x7bef, 0x7bef, 0x7bef, 0x7bef,
    0x8410, 0x8410, 0x8410, 0x8410, 0x8430, 0x8430, 0x8430, 0x8430,
    0x8c51, 0x8c51, 0x8c51, 0x8c51, 0x8c71, 0x8c71, 0x8c71, 0x8c71,
    0x9492, 0x9492, 0x9492, 0x9492, 0x94b2, 0x94b2, 0x94b2, 0x94b2,
    0x9cd3, 0x9cd3, 0x9cd3, 0x9cd3, 0x9cf3, 0x9cf3, 0x9cf3, 0x9cf3,
    0xa514, 0xa514, 0xa514, 0xa514, 0xa534, 0xa534, 0xa534, 0xa534,
    0xad55, 0xad55, 0xad55, 0xad55, 0xad75, 0xad75, 0xad75, 0xad75,
    0xb596, 0xb596, 0xb596, 0xb596, 0xb5b6, 0xb5b6, 0xb5b6, 0xb5b6,
    0xbdd7, 0xbdd7, 0xbdd7, 0xbdd7, 0xbdf7, 0xbdf7, 0xbdf7, 0xbdf7,
    0xc618, 0xc618, 0xc618, 0xc618, 0xc638, 0xc638, 0xc638, 0xc638,
    0xce59, 0xce59, 0xce59, 0xce59, 0xce79, 0xce79, 0xce79, 0xce79,
    0xd69a, 0xd69a, 0xd69a, 0xd69a, 0xd6ba, 0xd6ba, 0xd6ba, 0xd6ba,
    0xdedb, 0xdedb, 0xdedb, 0xdedb, 0xdefb, 0xdefb, 0xdefb, 0xdefb,
    0xe71c, 0xe71c, 0xe71c, 0xe71c, 0xe73c, 0xe73c, 0xe73c, 0xe73c,
    0xef5d, 0xef5d, 0xef5d, 0xef5d, 0xef7d, 0xef7d, 0xef7d, 0xef7d,
    0xf79e, 0xf79e, 0xf79e, 0xf79e, 0xf7be, 0xf7be, 0xf7be, 0xf7be,
    0xffdf, 0xffdf, 0xffdf, 0xffdf, 0xffff, 0xffff, 0xffff, 0xffff
};

static const uint16_t blackhot[256] = {
    0xffff, 0xffff, 0xffff, 0xffff, 0xffdf, 0xffdf, 0xffdf, 0xffdf, // 255, 255
    0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf79e, 0xf79e, 0xf79e, 0xf79e, // 247, 239
    0xef7d, 0xef7d, 0xef7d, 0xef7d, 0xef5d, 0xef5d, 0xef5d, 0xef5d, // ...
    0xe73c, 0xe73c, 0xe73c, 0xe73c, 0xe71c, 0xe71c, 0xe71c, 0xe71c,
    0xdefb, 0xdefb, 0xdefb, 0xdefb, 0xdedb, 0xdedb, 0xdedb, 0xdedb,
    0xd6ba, 0xd6ba, 0xd6ba, 0xd6ba, 0xd69a, 0xd69a, 0xd69a, 0xd69a,
    0xce79, 0xce79, 0xce79, 0xce79, 0xce59, 0xce59, 0xce59, 0xce59,
    0xc638, 0xc638, 0xc638, 0xc638, 0xc618, 0xc618, 0xc618, 0xc618,
    0xbdf7, 0xbdf7, 0xbdf7, 0xbdf7, 0xbdd7, 0xbdd7, 0xbdd7, 0xbdd7,
    0xb5b6, 0xb5b6, 0xb5b6, 0xb5b6, 0xb596, 0xb596, 0xb596, 0xb596,
    0xad75, 0xad75, 0xad75, 0xad75, 0xad55, 0xad55, 0xad55, 0xad55,
    0xa534, 0xa534, 0xa534, 0xa534, 0xa514, 0xa514, 0xa514, 0xa514,
    0x9cf3, 0x9cf3, 0x9cf3, 0x9cf3, 0x9cd3, 0x9cd3, 0x9cd3, 0x9cd3,
    0x94b2, 0x94b2, 0x94b2, 0x94b2, 0x9492, 0x9492, 0x9492, 0x9492,
    0x8c71, 0x8c71, 0x8c71, 0x8c71, 0x8c51, 0x8c51, 0x8c51, 0x8c51,
    0x8430, 0x8430, 0x8430, 0x8430, 0x8410, 0x8410, 0x8410, 0x8410,
    0x7bef, 0x7bef, 0x7bef, 0x7bef, 0x7bcf, 0x7bcf, 0x7bcf, 0x7bcf,
    0x73ae, 0x73ae, 0x73ae, 0x73ae, 0x738e, 0x738e, 0x738e, 0x738e,
    0x6b6d, 0x6b6d, 0x6b6d, 0x6b6d, 0x6b4d, 0x6b4d, 0x6b4d, 0x6b4d,
    0x632c, 0x632c, 0x632c, 0x632c, 0x630c, 0x630c, 0x630c, 0x630c,
    0x5aeb, 0x5aeb, 0x5aeb, 0x5aeb, 0x5acb, 0x5acb, 0x5acb, 0x5acb,
    0x52aa, 0x52aa, 0x52aa, 0x52aa, 0x528a, 0x528a, 0x528a, 0x528a,
    0x4a69, 0x4a69, 0x4a69, 0x4a69, 0x4a49, 0x4a49, 0x4a49, 0x4a49,
    0x4228, 0x4228, 0x4228, 0x4228, 0x4208, 0x4208, 0x4208, 0x4208,
    0x39e7, 0x39e7, 0x39e7, 0x39e7, 0x39c7, 0x39c7, 0x39c7, 0x39c7,
    0x31a6, 0x31a6, 0x31a6, 0x31a6, 0x3186, 0x3186, 0x3186, 0x3186,
    0x2965, 0x2965, 0x2965, 0x2965, 0x2945, 0x2945, 0x2945, 0x2945,
    0x2124, 0x2124, 0x2124, 0x2124, 0x2104, 0x2104, 0x2104, 0x2104,
    0x18e3, 0x18e3, 0x18e3, 0x18e3, 0x18c3, 0x18c3, 0x18c3, 0x18c3,
    0x10a2, 0x10a2, 0x10a2, 0x10a2, 0x1082, 0x1082, 0x1082, 0x1082,
    0x0861, 0x0861, 0x0861, 0x0861, 0x0841, 0x0841, 0x0841, 0x0841,
    0x0020, 0x0020, 0x0020, 0x0020, 0x0000, 0x0000, 0x0000, 0x0000
};

static const uint16_t* palettes[] = {ironbow, viridis, inferno, lava, whitehot, blackhot};

void init_buffers(lv_obj_t* canvas_obj)
{
    static lv_img_dsc_t dsc;

    if (nullptr == canvas_obj || nullptr == thermal_img) 
        return;
    
    lv_canvas_set_buffer(canvas_obj, legend_buffer, 10, 256, LV_IMG_CF_TRUE_COLOR);

    // 1. Define dimensions for the rotated buffer
    // Sensor is 32x24. We interpolate to 80x60 (90 deg rotated)

    heatmap_buf = (uint16_t*) heap_caps_malloc(out_w * out_h * 2, MALLOC_CAP_SPIRAM);

    dsc.header.always_zero = 0;
    dsc.header.w = out_w;   
    dsc.header.h = out_h;   
    dsc.header.cf = LV_IMG_CF_TRUE_COLOR;
    dsc.data = (uint8_t*)heatmap_buf;
    dsc.data_size = out_w * out_h * 2;

    // --- LVGL STYLING TO PREVENT TILING ---
    
    // Set source
    lv_img_set_src(thermal_img, &dsc);

    // Set the widget size to match buffer (Prevents tiling)
    lv_obj_set_size(thermal_img, out_w, out_h);

    // Zoom 6x (256 * 6 = 1536) 
    // This makes the 60x80 buffer appear as 360x480 on screen
    lv_img_set_zoom(thermal_img, 1536);

    // Set pivot to center of the 60x80 buffer
    lv_img_set_pivot(thermal_img, out_w / 2, out_h / 2);

    // Keep the widget in the center of the screen
    lv_obj_center(thermal_img);
}

void update_legend(lv_obj_t* canvas_obj, const uint16_t* palette) 
{
    lv_color_t lv_col;
    if (canvas_obj == nullptr)
        return;

    // Fill the buffer manually
    for(int y = 0; y < 256; y++) {
        // Invert Y so Hot is at the TOP (y=0)
        uint16_t raw_color = palette[255 - y]; 

        lv_col.full = raw_color >> 8 | raw_color << 8;
        // ESP_LOGV(TAG, "%d col %#x", y, lv_col.full);

        for(int x = 0; x < 10; x++) {
            legend_buffer[y * 10 + x] = lv_col;
        }
    }
    // Notify the canvas that the buffer changed and needs to redraw
    lv_obj_invalidate(canvas_obj);
}

void generate_heat_map(void)
{
    if (nullptr == heatmap_buf)
        return;

    float *raw_temps = nullptr;
    if (!termal->get_raw_pixels(&raw_temps))
        return;

    const uint16_t *col_map = palettes[id(active_palette_index)];

    float min_t = id(min_temp).state;
    float max_t = id(max_temp).state;
    float inv_range = (max_t != min_t) ? (255.0f / (max_t - min_t)) : 0.0f;

    for (int y = 0; y < out_h; y++) {
        for (int x = 0; x < out_w; x++) {
            
            // --- 90Â° CLOCKWISE ROTATION + INTERPOLATION ---
            float gy = x * (23.0f / (out_w - 1)); 
            float gx = y * (31.0f / (out_h - 1));

            int x0 = (int)gx;
            int x1 = (x0 < 31) ? x0 + 1 : 31;
            float dx = gx - x0;

            int y0 = (int)gy;
            int y1 = (y0 < 23) ? y0 + 1 : 23;
            float dy = gy - y0;

            float p00 = raw_temps[y0 * 32 + x0];
            float p10 = raw_temps[y0 * 32 + x1];
            float p01 = raw_temps[y1 * 32 + x0];
            float p11 = raw_temps[y1 * 32 + x1];

            float temp = p00 * (1.0f - dx) * (1.0f - dy) +
                         p10 * dx * (1.0f - dy) +
                         p01 * (1.0f - dx) * dy +
                         p11 * dx * dy;

            int color_idx = (int)((temp - min_t) * inv_range);
            if (color_idx < 0) color_idx = 0;
            if (color_idx > 255) color_idx = 255;
            
            uint16_t c = col_map[color_idx];
            // Swap bytes for SPI Display and store
            heatmap_buf[y * out_w + x] = (c << 8) | (c >> 8);
        }
    }
    termal->put_raw_pixels();
    lv_obj_invalidate(thermal_img);
}
#endif